---
title: "Rank Product Tests"
author: "Hannah Butler"
date: "7/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

## Finals Data
# you'll probably have to change these paths to get this to work
load("rp_data.rdata")
```

# About the Rank Product 
The Rank-Product test is a nonparametric test developed with the use in replicated gene expression experiments in mind. The idea is that we have $k$ sets of rankings for $n$ genes and want to know if a gene is differentially expressed. Outside of biology, this test also has applications in statistical meta-analysis and feature selection.

The rank-product $RP$ statistic is simply computed as the geometric mean of the rankings $r$ across the $k$ replicates for item $i = 1, 2, \dots, n$:

$$ RP_i = \Big( \prod_{j=1}^{k} r_{ij} \Big)^{1/k} $$

# Application to Olympic Sport Climbing
We believe this nonparametric test can be usefully applied to scoring data for the combined sport climbing events. We consider each of the 3 events a "replicate" for each climber, giving us $k=3$ sets of rankings. We then compute the rank product statistic for each climber, and compare it to a distribution of corresponding simulated rank products generated by uniformly and independently drawing a permutation of ranks for each event. Our test is to challenge this assumption that a climber's ranking is randomly achieved with equal odds.

## Function to Generate Rank Permutations

```{r}
assign_ranks <- function(c = 8) {
  # randomly assign ranks in 3 events & compute total
  # ranking in an event is considered to be independent from ranking in another event
  output <- data.frame(climber = sample(LETTERS, c, replace = FALSE)
                       , speed = sample(1:c, c, replace = FALSE)
                       , bould = sample(1:c, c, replace = FALSE)
                       , lead = sample(1:c, c, replace = FALSE)
                       ) %>%
    mutate(total = speed*bould*lead) %>%
    arrange(total)
  
  return(output)
}
```

# Computing the Rank-Product For Finalists
We start with the lower $n$ case

In the Combined-Event World Cup Climbing competitions, there are $n = 6$ competitors. We compute the geometric mean of their rankings for the three events:

## Men

```{r, echo = FALSE}
knitr::kable(m_fin_rp)
```

## Women

```{r, echo = FALSE}
knitr::kable(f_fin_rp)
```


```{r}
set.seed(80085)
n_perm <- 1000
# Rank Product for Finals (n = 6, k = 3)
fin_perms <- lapply(1:n_perm, function(x) assign_ranks(6) %>% mutate(rp = total^(1/3))
                    )

# list of rank-products for each total rank
rp_sets <- lapply(1:6, function(r) sapply(fin_perms, function(x) x$rp[r])
                  )
```

## Men's Finals
```{r}
E_m <- sapply(1:6, function(x) mean(m_fin_rp$rp[x] >= rp_sets[[x]]) # false discovery rate: /x
              )
```

```{r, echo = FALSE}
data.frame(last = m_fin_rp$last
           , first = m_fin_rp$first
           , rank = m_fin_rp$rank
           , rp = m_fin_rp$rp
           , pval = E_m
           ) %>% 
  knitr::kable()
```

## Women's Finals
```{r}
E_f <- sapply(1:6, function(x) mean(f_fin_rp$rp[x] >= rp_sets[[x]]) # false discovery rate:/x
              )
```

```{r, echo = FALSE}
data.frame(last = f_fin_rp$last
           , first = f_fin_rp$first
           , rank = f_fin_rp$rank
           , rp = f_fin_rp$rp
           , pval = E_f
           ) %>% 
  knitr::kable()
```

# Computing the Rank-Product For Qualifiers
```{r}
n_perm <- 1000
# Rank Product for Finals (n = 6, k = 3)
fin_perms <- lapply(1:n_perm, function(x) assign_ranks(21) %>% mutate(rp = total^(1/3))
                    )

# list of rank-products for each total rank
rp_sets <- lapply(1:21, function(r) sapply(fin_perms, function(x) x$rp[r])
                  )
```

## Men's Qualifiers
```{r}
E_m <- sapply(1:21, function(x) mean(m_qual_rp$rp[x] >= rp_sets[[x]]) # false discovery rate: /x
              )
```

```{r, echo = FALSE}
data.frame(last = m_qual_rp$last
           , first = m_qual_rp$first
           , rank = m_qual_rp$rank
           , rp = m_qual_rp$rp
           , pval = E_m
           ) %>% 
  knitr::kable()
```

## Women's Qualifiers
```{r}
E_f <- sapply(1:21, function(x) mean(f_qual_rp$rp[x] >= rp_sets[[x]]) # false discovery rate: /x
              )
```

```{r, echo = FALSE}
data.frame(last = f_qual_rp$last
           , first = f_qual_rp$first
           , rank = f_qual_rp$rank
           , rp = f_qual_rp$rp
           , pval = E_f
           ) %>% 
  knitr::kable()
```